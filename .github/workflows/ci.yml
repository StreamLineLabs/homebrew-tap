name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly check to catch Homebrew API changes
    - cron: "0 9 * * 1"

jobs:
  lint:
    name: Formula Lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Ruby syntax check
        run: ruby -c streamline.rb

      - name: Homebrew audit (basic)
        run: |
          brew tap-new streamlinelabs/test --no-git
          cp streamline.rb "$(brew --repository streamlinelabs/test)/Formula/streamline.rb"
          brew audit --formula streamlinelabs/test/streamline

      - name: Homebrew audit (strict)
        run: brew audit --strict --formula streamlinelabs/test/streamline || true

      - name: Homebrew style check
        run: brew style streamlinelabs/test/streamline || true

  test-macos-arm:
    name: Test (macOS ARM64)
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install from tap
        run: |
          brew tap-new streamlinelabs/test --no-git
          cp streamline.rb "$(brew --repository streamlinelabs/test)/Formula/streamline.rb"
          brew install streamlinelabs/test/streamline || echo "::warning::Install failed (expected if placeholder hashes)"

      - name: Run brew test
        if: success()
        run: brew test streamlinelabs/test/streamline || echo "::warning::Test failed (expected if placeholder hashes)"

      - name: Verify binaries
        if: success()
        run: |
          streamline --version || true
          streamline --help | head -5 || true
          streamline-cli --help | head -5 || true

  test-macos-intel:
    name: Test (macOS Intel)
    runs-on: macos-13
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Install from tap
        run: |
          brew tap-new streamlinelabs/test --no-git
          cp streamline.rb "$(brew --repository streamlinelabs/test)/Formula/streamline.rb"
          brew install streamlinelabs/test/streamline || echo "::warning::Install failed (expected if placeholder hashes)"

      - name: Run brew test
        if: success()
        run: brew test streamlinelabs/test/streamline || echo "::warning::Test failed (expected if placeholder hashes)"

      - name: Verify binaries
        if: success()
        run: |
          streamline --version || true
          streamline --help | head -5 || true

  test-linux:
    name: Test (Linux x86_64)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install from tap
        run: |
          brew tap-new streamlinelabs/test --no-git
          cp streamline.rb "$(brew --repository streamlinelabs/test)/Formula/streamline.rb"
          brew install streamlinelabs/test/streamline || echo "::warning::Install failed (expected if placeholder hashes)"

      - name: Run brew test
        if: success()
        run: brew test streamlinelabs/test/streamline || echo "::warning::Test failed (expected if placeholder hashes)"

  head-build:
    name: Head Build (from source)
    runs-on: macos-latest
    needs: lint
    # Only run on main branch or manual triggers to avoid long CI times on PRs
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install from HEAD
        run: |
          brew tap-new streamlinelabs/test --no-git
          cp streamline.rb "$(brew --repository streamlinelabs/test)/Formula/streamline.rb"
          brew install --HEAD streamlinelabs/test/streamline
        continue-on-error: true
